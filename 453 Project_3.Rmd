---
title: "453Proj_SCIext"
author: "Wei Dai and Joshua Wu"
date: "7/26/2019"
output: html_document
---

```{r message=FALSE}
library(rms) # multi-logistic regression
library(MASS) # polr
library(nnet) # multinom
library(glmnet) # lasso
library(viridis)
library(ggridges)
library(tidyverse)
```

```{r}
sci_raw <- read_csv("curated_fulldata.csv")
sub_sci <- sci_raw %>% select(extBlEmp, Age, Sex, yr, hand, FnBr, blMed, blAsst, blSense)
sub_sci[c(1, 3, 5:9)] <- lapply(sub_sci[c(1, 3, 5:9)], as.factor)

summary(sub_sci)
sub_sci_clean <- sub_sci %>% filter(complete.cases(.)) # remove NAs
```

# preliminary analysis

first step is preliminary analysis: a kitchen sink model of porpotional odds model and multinom model.

## polr

```{r}
mod_polr <- polr(extBlEmp ~., data = sub_sci_clean, Hess = T)

summary(mod_polr)
```

Some levels could be lumped together 1:3, 4:6, 7:8(intercept are very similar)

## multinom 

```{r}
mod_mtn <- multinom(extBlEmp ~., data = sub_sci_clean, Hess = T, trace = F)
summary(mod_mtn)
```

## LRT

```{r}
pchisq(q = mod_polr$deviance - mod_mtn$deviance, df = mod_mtn$edf - mod_polr$edf, lower.tail = F)
```

`polr` is not sufficient in describing the data, multinom is required to better fit the data

take away:

* Some levels of outcome variables could be merged

* multimon is a better choice than polr

```{r}
# merge into 3 categories
sub_sci_clean <- sub_sci_clean %>% 
  mutate(newBlEmp = fct_recode(extBlEmp, "Very Likely" = "1",
                               "Very Likely" = "2",
                               "Very Likely" = "3",
                               "Somewhat Likely" = "4",
                               "Somewhat Likely" = "5",
                               "Somewhat Likely" = "6",
                               "Not Likely" = "7",
                               "Not Likely" = "8"),
         )

# make it ordered factor
sub_sci_clean$newBlEmp_ord <- factor(sub_sci_clean$newBlEmp, 
                                 levels = c("Very Likely", "Somewhat Likely", "Not Likely"), ordered = T)

is.ordered(sub_sci_clean$newBlEmp_ord)
```

```{r}
mod_polr3 <- polr(newBlEmp_ord ~., data = sub_sci_clean[-c(1, 10)], Hess = T)
summary(mod_polr3)
mod_mtn3 <- multinom(newBlEmp ~., data = sub_sci_clean[-c(1, 11)], Hess = T, trace = F)
summary(mod_mtn3)

pchisq(q = mod_polr3$deviance - mod_mtn3$deviance, df = mod_mtn3$edf - mod_polr3$edf, lower.tail = F)

```

# Exploratory data analysis

```{r}
sub_sci_clean %>% 
  ggplot(aes(x = Age, y = newBlEmp, fill = ..x..)) +
  geom_density_ridges_gradient() + 
  scale_fill_viridis(option = "C", name = "Age") + 
  xlim(0, 100) + theme_minimal() + labs(title = "Age density comparsion among BlEmp status")
```

```{r}
sub_sci_clean %>% 
  ggplot(aes(x = yr, y = newBlEmp, fill = ..x..)) +
  geom_density_ridges_gradient() + 
  scale_fill_viridis(option = "C", name = "Years Diagnosed") + 
  xlim(0, 100) + theme_minimal() + labs(title = "Years Diagnosed density comparsion among BlEmp status")
```

```{r}
counts <- table(sub_sci_clean$newBlEmp_ord, sub_sci_clean$Sex)
barplot(counts, main="Ordinal Distribution by Sex", xlab = "Sex", ylab = "Count of Ordinal Factors", col = c("darkblue", "red", "green"), legend = rownames(counts) ,args.legend = list(x = "topleft"),beside = TRUE)

```

```{r}
counts <- table(sub_sci_clean$newBlEmp_ord, sub_sci_clean$hand)
barplot(counts, main="Ordinal Distribution by Hand Function", xlab = "Hand Function", ylab = "Count of Ordinal Factors", col = c("darkblue", "red", "green"), legend = rownames(counts) ,beside = TRUE)

```

```{r}
counts <- table(sub_sci_clean$newBlEmp_ord, sub_sci_clean$FnBr)
barplot(counts, main="Ordinal Distribution by Financial Barrier", xlab = "Financial Barrier", ylab = "Count of Ordinal Factors", col = c("darkblue", "red", "green"), legend = rownames(counts) ,beside = TRUE)

```

# Stepwise and Results

```{r}
sub_sci_clean$newBlEmp_ord <- factor(sub_sci_clean$newBlEmp, 
                                 levels = c("Not Likely", "Somewhat Likely", "Very Likely"), ordered = T)

mod_polr2 <- polr(newBlEmp_ord ~., data = sub_sci_clean[-c(1, 10)], Hess = T)
mod_polr2_step <- step(mod_polr2, trace = F)

summary(mod_polr2_step)

car::Anova(mod_polr2_step)
```

